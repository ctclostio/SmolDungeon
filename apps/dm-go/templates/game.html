<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SmolDungeon - Round {{.State.Round}}</title>
    <style>
        body { 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; 
            margin: 0; 
            padding: 20px; 
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }
        .container { 
            max-width: 1200px; 
            margin: 0 auto; 
            background: white; 
            border-radius: 15px; 
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        .header { 
            background: linear-gradient(135deg, #2c3e50, #34495e);
            color: white;
            padding: 30px; 
            text-align: center; 
        }
        .header h1 { 
            margin: 0 0 10px 0; 
            font-size: 2.5em;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }
        .status { 
            font-size: 1.2em; 
            padding: 15px; 
            text-align: center; 
            font-weight: bold;
            border-radius: 8px;
            margin: 20px;
        }
        .status.active { 
            background: linear-gradient(135deg, #4CAF50, #45a049); 
            color: white; 
            box-shadow: 0 4px 15px rgba(76, 175, 80, 0.4);
        }
        .status.waiting { 
            background: linear-gradient(135deg, #FF9800, #F57C00); 
            color: white; 
            box-shadow: 0 4px 15px rgba(255, 152, 0, 0.4);
        }
        .game-grid { 
            display: grid; 
            grid-template-columns: 1fr 350px; 
            gap: 30px; 
            padding: 30px;
        }
        .combat-map { 
            background: #f8f9fa; 
            padding: 25px; 
            border-radius: 12px; 
            border: 2px solid #e9ecef;
        }
        .character-grid { 
            display: grid; 
            grid-template-columns: repeat(5, 1fr); 
            gap: 8px; 
            margin: 20px 0;
            max-width: 400px;
            margin-left: auto;
            margin-right: auto;
        }
        .character { 
            border: 2px solid #ddd; 
            padding: 12px; 
            border-radius: 8px; 
            text-align: center; 
            position: relative; 
            min-height: 70px;
            transition: all 0.3s ease;
            cursor: pointer;
        }
        .character:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }
        .character.player { 
            background: linear-gradient(135deg, #4CAF50, #45a049); 
            color: white; 
            border-color: #4CAF50;
        }
        .character.enemy { 
            background: linear-gradient(135deg, #f44336, #d32f2f); 
            color: white; 
            border-color: #f44336;
        }
        .character.current-turn { 
            border-color: #2196F3; 
            box-shadow: 0 0 20px rgba(33, 150, 243, 0.6);
            transform: scale(1.05);
        }
        .character.dead { 
            opacity: 0.4; 
            background: #9E9E9E;
            cursor: not-allowed;
        }
        .character.low-health { 
            border-color: #FF9800;
            animation: pulse 2s infinite;
        }
        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(255, 152, 0, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(255, 152, 0, 0); }
            100% { box-shadow: 0 0 0 0 rgba(255, 152, 0, 0); }
        }
        .health-bar { 
            position: absolute; 
            bottom: 5px; 
            left: 5px; 
            right: 5px; 
            height: 6px; 
            background: rgba(0,0,0,0.3); 
            border-radius: 3px; 
            overflow: hidden;
        }
        .health-fill { 
            height: 100%; 
            border-radius: 3px; 
            transition: width 0.3s ease;
        }
        .sidebar { 
            background: #f8f9fa; 
            padding: 25px; 
            border-radius: 12px; 
            border: 2px solid #e9ecef;
        }
        .action-buttons { 
            display: flex; 
            flex-direction: column; 
            gap: 12px; 
            margin: 20px 0;
        }
        .btn { 
            padding: 15px; 
            border: none; 
            border-radius: 8px; 
            cursor: pointer; 
            font-size: 16px; 
            font-weight: bold; 
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        .btn:hover:not(:disabled) { 
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(0,0,0,0.2);
        }
        .btn:disabled { 
            opacity: 0.5; 
            cursor: not-allowed; 
            transform: none;
        }
        .btn-attack { 
            background: linear-gradient(135deg, #f44336, #d32f2f); 
            color: white; 
        }
        .btn-defend { 
            background: linear-gradient(135deg, #2196F3, #1976D2); 
            color: white; 
        }
        .btn-ability { 
            background: linear-gradient(135deg, #9C27B0, #7B1FA2); 
            color: white; 
        }
        .btn-item { 
            background: linear-gradient(135deg, #FF9800, #F57C00); 
            color: white; 
        }
        .btn-flee { 
            background: linear-gradient(135deg, #607D8B, #455A64); 
            color: white; 
        }
        .combat-log { 
            background: white; 
            border: 2px solid #e9ecef; 
            border-radius: 8px; 
            padding: 20px; 
            max-height: 300px; 
            overflow-y: auto;
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.1);
        }
        .log-entry { 
            margin: 8px 0; 
            padding: 8px; 
            background: #f8f9fa; 
            border-radius: 4px;
            border-left: 4px solid #007bff;
            animation: slideIn 0.3s ease;
        }
        @keyframes slideIn {
            from { opacity: 0; transform: translateX(-20px); }
            to { opacity: 1; transform: translateX(0); }
        }
        .turn-indicator { 
            text-align: center; 
            font-size: 1.3em; 
            font-weight: bold; 
            margin: 20px 0; 
            padding: 15px; 
            background: linear-gradient(135deg, #e3f2fd, #bbdefb); 
            border-radius: 8px;
            border: 2px solid #2196F3;
        }
        .legend {
            text-align: center; 
            margin-top: 15px; 
            font-size: 0.9em; 
            color: #666;
            background: white;
            padding: 10px;
            border-radius: 6px;
            border: 1px solid #ddd;
        }
        .legend-item {
            display: inline-block;
            margin: 0 10px;
            padding: 5px 10px;
            border-radius: 4px;
            background: #f8f9fa;
        }
        h2, h3 { 
            color: #007bff; 
            margin: 0 0 15px 0;
            text-align: center;
        }
        .character-name {
            font-weight: bold;
            font-size: 0.9em;
            margin-bottom: 5px;
        }
        .character-stats {
            font-size: 0.8em;
            opacity: 0.9;
        }
        #action-buttons {
            animation: fadeIn 0.5s ease;
        }
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        .websocket-status {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 10px 15px;
            border-radius: 20px;
            font-size: 0.9em;
            font-weight: bold;
            z-index: 1000;
            transition: all 0.3s ease;
        }
        .websocket-status.connected {
            background: linear-gradient(135deg, #4CAF50, #45a049);
            color: white;
        }
        .websocket-status.disconnected {
            background: linear-gradient(135deg, #f44336, #d32f2f);
            color: white;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>‚öîÔ∏è SmolDungeon - Round {{.State.Round}}</h1>
            <p>Go-Powered Turn-Based Combat</p>
        </div>

        <div class="websocket-status" id="ws-status">Connecting...</div>

        {{if .IsPlayerTurn}}
        <div class="status active">üéØ Your Turn! Take Action!</div>
        {{else}}
        <div class="status waiting">‚è≥ Waiting for opponent...</div>
        {{end}}

        <div class="game-grid">
            <div class="combat-map">
                <h2>üó∫Ô∏è Combat Map</h2>
                <div class="character-grid">
                    {{range $y := iterate -2 2}}
                        {{range $x := iterate -2 2}}
                            {{$char := characterAt $.State.Characters $x $y}}
                            {{if $char}}
                                <div class="{{renderCharacterClass $char (eq $char.ID (index $.State.TurnOrder $.State.CurrentTurn))}}" 
                                     title="{{$char.Name}} {{formatPosition $char.Position}} - {{formatHealth $char.Stats.HP $char.Stats.MaxHP}} HP">
                                    <div class="character-name">{{$char.Name}}</div>
                                    <div class="character-stats">{{formatHealth $char.Stats.HP $char.Stats.MaxHP}}</div>
                                    <div class="health-bar">
                                        <div class="health-fill" style="width: {{percentHealth $char.Stats.HP $char.Stats.MaxHP}}%; background-color: {{getHealthColor $char.Stats.HP $char.Stats.MaxHP}};"></div>
                                    </div>
                                </div>
                            {{else}}
                                <div class="character" style="background: #E8F5E8; border: 1px solid #C8E6C9;"></div>
                            {{end}}
                        {{end}}
                    {{end}}
                </div>
                <div class="legend">
                    <div class="legend-item">üü¢ Player</div>
                    <div class="legend-item">üî¥ Enemy</div>
                    <div class="legend-item">üîµ Current Turn</div>
                    <div class="legend-item">üü° Low HP</div>
                    <div class="legend-item">‚ö´ Dead</div>
                </div>
            </div>

            <div class="sidebar">
                <div class="turn-indicator">
                    {{if .CurrentChar}}{{.CurrentChar.Name}}'s Turn{{else}}Unknown Turn{{end}}
                </div>

                {{if .IsPlayerTurn}}
                <div id="action-buttons">
                    <div class="action-buttons">
                        <button class="btn btn-attack" onclick="sendAction('attack')">‚öîÔ∏è Attack</button>
                        <button class="btn btn-defend" onclick="sendAction('defend')">üõ°Ô∏è Defend</button>
                        <button class="btn btn-ability" onclick="sendAction('ability')">‚ú® Ability</button>
                        <button class="btn btn-item" onclick="sendAction('item')">üéí Use Item</button>
                        <button class="btn btn-flee" onclick="sendAction('flee')">üèÉ Flee</button>
                    </div>
                </div>
                {{end}}

                <div class="combat-log">
                    <h3>üìú Combat Log</h3>
                    <div id="log-entries">
                        <div class="log-entry">Combat begins! Round {{.State.Round}}</div>
                        <div class="log-entry">{{if .IsPlayerTurn}}Your turn to act!{{else}}Enemy is planning their move...{{end}}</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let ws;
        let sessionId = '{{.SessionID}}';
        let currentState = {{json .State}};

        function connectWebSocket() {
            const wsUrl = `ws://localhost:3000/ws/${sessionId}`;
            ws = new WebSocket(wsUrl);
            
            const statusEl = document.getElementById('ws-status');
            
            ws.onopen = function() {
                console.log('WebSocket connected');
                statusEl.textContent = 'Connected';
                statusEl.className = 'websocket-status connected';
            };
            
            ws.onmessage = function(event) {
                const data = JSON.parse(event.data);
                if (data.type === 'game_update') {
                    updateGameState(data.state);
                } else if (data.type === 'combat_log') {
                    addLogEntry(data.message);
                }
            };
            
            ws.onclose = function() {
                console.log('WebSocket disconnected, reconnecting...');
                statusEl.textContent = 'Disconnected';
                statusEl.className = 'websocket-status disconnected';
                setTimeout(connectWebSocket, 1000);
            };
            
            ws.onerror = function(error) {
                console.error('WebSocket error:', error);
            };
        }

        function sendAction(actionType, targetData = {}) {
            if (ws && ws.readyState === WebSocket.OPEN) {
                ws.send(JSON.stringify({
                    type: 'action',
                    action: actionType,
                    ...targetData
                }));
            } else {
                // Fallback to HTTP
                fetch(`/game/${sessionId}/action`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ action: actionType, ...targetData })
                }).then(response => response.json())
                  .then(data => {
                      if (data.success) {
                          addLogEntries(data.logs);
                      }
                  });
            }
        }

        function updateGameState(newState) {
            currentState = newState;
            // Update UI elements based on new state
            updateTurnIndicator(newState);
            updateActionButtons(newState);
            
            if (newState.isComplete) {
                showGameEnd(newState);
            }
        }

        function updateTurnIndicator(state) {
            const indicator = document.querySelector('.turn-indicator');
            const currentChar = state.characters[state.currentTurn];
            if (currentChar) {
                indicator.textContent = currentChar.name + "'s Turn";
            }
        }

        function updateActionButtons(state) {
            const currentChar = state.characters[state.currentTurn];
            const isPlayerTurn = currentChar && currentChar.isPlayer;
            const actionButtons = document.getElementById('action-buttons');
            if (actionButtons) {
                actionButtons.style.display = isPlayerTurn ? 'block' : 'none';
            }
        }

        function addLogEntry(message) {
            const logEntries = document.getElementById('log-entries');
            const entry = document.createElement('div');
            entry.className = 'log-entry';
            entry.textContent = message;
            logEntries.appendChild(entry);
            logEntries.scrollTop = logEntries.scrollHeight;
        }

        function addLogEntries(logs) {
            logs.forEach(log => addLogEntry(log));
        }

        function showGameEnd(state) {
            const winner = state.winner || 'Unknown';
            const message = winner === 'player' ? 'üéâ Victory! You have defeated all enemies!' : 'üíÄ Defeat! Your party has fallen...';
            setTimeout(() => alert(message), 500);
        }

        // Initialize
        connectWebSocket();
        
        // Auto-refresh every 30 seconds as backup
        setInterval(() => {
            if (!ws || ws.readyState !== WebSocket.OPEN) {
                location.reload();
            }
        }, 30000);
    </script>
</body>
</html>